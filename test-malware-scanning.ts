/**
 * Test Script: Malware Scanning Edge Function
 * Tests Phase 8 malware scanning integration
 */

import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const SUPABASE_URL = 'https://gnurilaiddffxfjujegu.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdudXJpbGFpZGRmZnhmanVqZWd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NDk3MzksImV4cCI6MjA3ODMyNTczOX0.FSjyDjyxSBzDT6vUYGhgwJ946noSbeUkXIvuTlYoSYw'

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// Create a minimal valid PNG file (1x1 transparent pixel)
const createTestImage = (): Uint8Array => {
  // PNG signature + IHDR + IDAT + IEND chunks for 1x1 transparent image
  return new Uint8Array([
    0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A, // PNG signature
    0x00, 0x00, 0x00, 0x0D, 0x49, 0x48, 0x44, 0x52, // IHDR chunk
    0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, // 1x1 dimensions
    0x08, 0x06, 0x00, 0x00, 0x00, 0x1F, 0x15, 0xC4,
    0x89, 0x00, 0x00, 0x00, 0x0A, 0x49, 0x44, 0x41, // IDAT chunk
    0x54, 0x78, 0x9C, 0x63, 0x00, 0x01, 0x00, 0x00,
    0x05, 0x00, 0x01, 0x0D, 0x0A, 0x2D, 0xB4, 0x00,
    0x00, 0x00, 0x00, 0x49, 0x45, 0x4E, 0x44, 0xAE, // IEND chunk
    0x42, 0x60, 0x82
  ])
}

// Create a malicious file (executable signature)
const createMaliciousFile = (): Uint8Array => {
  // MZ header (Windows executable)
  return new Uint8Array([
    0x4D, 0x5A, // MZ signature
    0x90, 0x00, 0x03, 0x00, 0x00, 0x00, 0x04, 0x00,
    0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xB8, 0x00
  ])
}

async function testSafeFileUpload() {
  console.log('\n=== Test 1: Safe File Upload (Valid PNG) ===')

  // Create anonymous session
  const { data: session, error: sessionError } = await supabase
    .from('upload_sessions')
    .insert({
      session_type: 'single',
      total_files: 1,
      total_size_bytes: 100,
      status: 'pending',
      is_anonymous: true,
      expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
    })
    .select()
    .single()

  if (sessionError) {
    console.log(`❌ Failed to create session: ${sessionError.message}`)
    return false
  }

  console.log(`✅ Created session: ${session.id}`)

  // Upload test image to Supabase Storage
  const testImage = createTestImage()
  const fileName = `test-${Date.now()}.png`
  const storagePath = `${session.id}/${fileName}`

  const { data: uploadData, error: uploadError } = await supabase.storage
    .from('temp-uploads')
    .upload(storagePath, testImage, {
      contentType: 'image/png',
      upsert: false,
    })

  if (uploadError) {
    console.log(`❌ Failed to upload file: ${uploadError.message}`)
    await supabase.from('upload_sessions').delete().eq('id', session.id)
    return false
  }

  console.log(`✅ Uploaded file to storage: ${storagePath}`)

  // Call process-upload edge function
  const { data: processData, error: processError } = await supabase.functions.invoke('process-upload', {
    body: {
      sessionId: session.id,
      storagePath: storagePath,
      filename: fileName,
      fileSize: testImage.length,
      mimeType: 'image/png',
    },
  })

  // Cleanup
  await supabase.storage.from('temp-uploads').remove([storagePath])
  await supabase.from('upload_sessions').delete().eq('id', session.id)

  if (processError) {
    console.log(`❌ Edge function error: ${processError.message}`)
    return false
  }

  if (processData.error) {
    console.log(`❌ Processing failed: ${processData.error}`)
    console.log(`   Code: ${processData.code}`)
    return false
  }

  console.log(`✅ File processed successfully (malware scan passed)`)
  console.log(`   Asset ID: ${processData.asset?.id}`)
  console.log(`   File Type: ${processData.asset?.fileType}`)
  console.log(`   Validation: ${processData.asset?.validationStatus}`)

  return true
}

async function testMaliciousFileBlocked() {
  console.log('\n=== Test 2: Malicious File Blocked (EXE Signature) ===')

  // Create anonymous session
  const { data: session, error: sessionError } = await supabase
    .from('upload_sessions')
    .insert({
      session_type: 'single',
      total_files: 1,
      total_size_bytes: 100,
      status: 'pending',
      is_anonymous: true,
      expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
    })
    .select()
    .single()

  if (sessionError) {
    console.log(`❌ Failed to create session: ${sessionError.message}`)
    return false
  }

  console.log(`✅ Created session: ${session.id}`)

  // Upload malicious file (disguised as PNG)
  const maliciousFile = createMaliciousFile()
  const fileName = `malicious-${Date.now()}.png`
  const storagePath = `${session.id}/${fileName}`

  const { data: uploadData, error: uploadError } = await supabase.storage
    .from('temp-uploads')
    .upload(storagePath, maliciousFile, {
      contentType: 'image/png',
      upsert: false,
    })

  if (uploadError) {
    console.log(`❌ Failed to upload file: ${uploadError.message}`)
    await supabase.from('upload_sessions').delete().eq('id', session.id)
    return false
  }

  console.log(`✅ Uploaded malicious file to storage: ${storagePath}`)

  // Call process-upload edge function
  const { data: processData, error: processError } = await supabase.functions.invoke('process-upload', {
    body: {
      sessionId: session.id,
      storagePath: storagePath,
      filename: fileName,
      fileSize: maliciousFile.length,
      mimeType: 'image/png',
    },
  })

  // Cleanup session (file should already be deleted by edge function)
  await supabase.from('upload_sessions').delete().eq('id', session.id)

  // We EXPECT an error here (malware detected)
  if (processData && processData.code === 'MALWARE_DETECTED') {
    console.log(`✅ Malware detected and blocked!`)
    console.log(`   Threat: ${processData.threat}`)
    console.log(`   Details: ${processData.details}`)
    return true
  } else {
    console.log(`❌ Malware NOT detected (security issue!)`)
    console.log(`   Response:`, processData)
    return false
  }
}

async function runTests() {
  console.log('╔══════════════════════════════════════════════════╗')
  console.log('║  ShareMyAd - Malware Scanning Test Suite       ║')
  console.log('║  Edge Function: process-upload                  ║')
  console.log('╚══════════════════════════════════════════════════╝')

  try {
    const test1 = await testSafeFileUpload()
    const test2 = await testMaliciousFileBlocked()

    console.log('\n╔══════════════════════════════════════════════════╗')
    if (test1 && test2) {
      console.log('║  ✅ ALL MALWARE SCANNING TESTS PASSED          ║')
    } else {
      console.log('║  ❌ SOME TESTS FAILED                          ║')
      console.log(`║     Safe File: ${test1 ? '✅' : '❌'}                                  ║`)
      console.log(`║     Malicious File: ${test2 ? '✅' : '❌'}                            ║`)
    }
    console.log('╚══════════════════════════════════════════════════╝')

    if (!test1 || !test2) {
      Deno.exit(1)
    }

  } catch (error) {
    console.error('\n❌ TEST SUITE ERROR:', error)
    Deno.exit(1)
  }
}

// Run tests
runTests()
